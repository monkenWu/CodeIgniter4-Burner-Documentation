<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>OpenSwoole Implement</title>
    <meta name="description" content="Documentation for CodeIgniter4 Burner v1.0.0">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Sans+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/en/assets/normalize.css?v=1679822342"
        media="screen" />
    <link rel="stylesheet" type="text/css" href="/en/assets/doctave-style.css?v=1679822342"
        media="screen" />
    <link rel="stylesheet" type="text/css" href="/en/assets/katex.css?v=1679822342" media="screen" />
    <link rel="stylesheet" type="text/css" href="/en/assets/prism-ghcolors.css?v=1679822342"
        media="screen" />

    <script>
        var DOCTAVE_TIMESTAMP = "1679822342";
        var BASE_PATH = "/en/";
        var color = localStorage.getItem('doctave-color')

        if (color === 'dark') {
            document.getElementsByTagName('html')[0].classList.remove('light');
            document.getElementsByTagName('html')[0].classList.add('dark');
        } else {
            document.getElementsByTagName('html')[0].classList.remove('dark');
            document.getElementsByTagName('html')[0].classList.add('light');
        }
    </script>

    
    <link rel="icon" type="image/x-icon" href="/favicon.ico"> 
<script>
    document.title = 'CodeIgniter4 Burner - ' + document.title;
</script>
    
</head>

<body>
    <label for='menu-toggle-switch' class='menu-toggle-button'>
        â˜°
    </label>
    <input type="checkbox" id="menu-toggle-switch" value='0' />
    <div class='page'>
        <div class='header'>
            <div class='logo'>
                
                <a href="/en/">
                    <img src="/en/logo.png" alt='CodeIgniter4 Burner v1.0.0 logo'></img>
                </a>
                
                <h2 class='project-name'>
                    <a href="/en/">
                        CodeIgniter4 Burner v1.0.0
                    </a>
                </h2>
            </div>
            <div class='search'>
                <form id='search-form'>
    <input type='text' id='search-box' autocomplete="off" placeholder="Search..."></input>
    <span class='search-icon'>S</span>
    <ul id='search-results'></ul>
</form>

            </div>
            <div class='header-dummy-right'>
            </div>
        </div>
        <div class='container'>
            <div class='sidebar-left'>
                <nav class='site-nav'>
    <ul>
        
            <li><a href="/en/introduction">Welcome to Burner!</a></li>
            
        
            <li><a href="/en/general">General</a></li>
            
                <ul>
    
        <li><a href="/en/general/quickstart">Quickstart</a></li>
        
    
        <li><a href="/en/general/suggestion">Development Suggestion</a></li>
        
    
        <li><a href="/en/general/docker">Docker Environment</a></li>
        
    
</ul>

            
        
            <li><a href="/en/openswoole">OpenSwoole</a></li>
            
                <ul>
    
        <li><a class="active" href="/en/openswoole/implement">OpenSwoole Implement</a></li>
        
    
        <li><a href="/en/openswoole/suggestion">OpenSwoole Suggestion</a></li>
        
    
        <li><a href="/en/openswoole/commands">OpenSwoole Commands</a></li>
        
    
</ul>

            
        
    </ul>
    <span id='light-dark-mode-switch'>
        <svg xmlns="http://www.w3.org/2000/svg" id="dark-mode-icon" viewBox="0 0 20 20" fill="currentColor">
            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
        </svg>

        <svg xmlns="http://www.w3.org/2000/svg" id="light-mode-icon" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
        </svg>
    </span>
</nav>

            </div>
            <div class='doctave-content'>
                <h1 id="openswoole-http">OpenSwoole HTTP</h1>
<p>Burner provides a HTTP server that is similar to infrastructure-level support. If you choose OpenSwoole-HTTP as your server solution, you should not be able to notice the existence of Burner in your development.</p>
<p>You can see the following code snippet in the <code>server</code> method in <code>project_root/app/Config/OpenSwoole.php</code>:</p>
<pre><code class="language-php">$server-&gt;on('request', static function (Request $swooleRequest, Response $swooleResponse) {
    // Burner handles CodeIgniter4 entry points.
    Worker::httpProcesser($swooleRequest, $swooleResponse);
});
</code></pre>
<p>All HTTP requests are handled from <code>Worker::httpProcesser</code>, and when this static method is called, it will convert the OpenSwoole request object to a request object that implements the <code>PSR-7</code> interface, and then pass the <code>PSR-7</code> request object to <code>burner-core</code> for processing. When <code>burner-core</code> receives the <code>PSR-7</code> request object, it will convert it to a request object that is exclusive to <code>CodeIgniter4</code>, and include some pre-processing required by the framework.</p>
<p>When <code>CodeIgniter4</code> has finished processing the request, <code>burner-core</code> will convert the <code>CodeIgniter4</code> response object to a <code>PSR-7</code> response object, and then return it to the OpenSwoole driver.</p>
<h2 id="events">Events</h2>
<p>CodeIgniter4 provides <a href="https://codeigniter.com/user_guide/extending/events.html">events</a> that can be used to perform actions at specific points during execution. When CodeIgniter runs, it follows a certain execution order, but in some cases, you may want to perform some actions at a specific stage of execution.</p>
<p>Burner provides the following events for OpenSwoole HTTP:</p>
<h3 id="burneraftersendresponse">burnerAfterSendResponse</h3>
<p>This is usually used to initialize after the response, if you have some global variables that need to be cleared or some common processing after the response, it is very suitable to declare it in this event. You can declare the <code>burnerAfterSendResponse</code> event, and when OpenSwoole responds, the logic you need to execute will be executed:</p>
<pre><code class="language-php">Events::on('burnerAfterSendResponse',static function(\OpenSwoole\Http\Server $server)
{
    //Your logic
});
</code></pre>
<p>The way events are used is not limited to callback functions. Please refer to the methods mentioned in the <a href="https://codeigniter.com/user_guide/extending/events.html#defining-an-event">CodeIgniter4 User Guide</a> to choose the best way for you.</p>
<h1 id="openswoole-websocket">OpenSwoole Websocket</h1>
<p>Burner provides a WebSocket server integration for OpenSwoole WebSocket Server. In development, you must follow some usage rules to deeply integrate WebSocket into your CodeIgniter4 project.</p>
<p>First, you need to use the <code>php spark burner:init OpenSwoole websocket</code> command to get the WebSocket-specific configuration file <code>project_root/app/Config/OpenSwoole.php</code>, you should see the following member method change (different from the HTTP configuration).</p>
<pre><code class="language-php">public function server(Server $server)
{
    $server-&gt;on('open', static function (Server $server, Request $request) {
        Worker::setWebsocket($request);
        Worker::push(
            data: 'hi! It\'s Burner Websocket!',
            fd: $request-&gt;fd
        );
    });

    $server-&gt;on('message', static function (Server $server, Frame $frame) {
        // Burner handles CodeIgniter4 entry points.
        Worker::websocketProcesser($frame, static function (Server $server, Frame $frame) {
            // Not Found Handling
        });
    });

    $server-&gt;on('request', static function (Request $swooleRequest, Response $swooleResponse) {
        // Burner handles CodeIgniter4 entry points.
        Worker::httpProcesser($swooleRequest, $swooleResponse);
    });

    $server-&gt;on('close', static function (Server $server, int $fd) {
        Worker::unsetWebsocket($fd);
        fwrite(STDOUT, sprintf(
            "client-%d is closed\n",
            $fd,
        ));
    });
}
</code></pre>
<p>In the above code snippet, you can see the <code>on('open')</code> event, which will be triggered when the WebSocket connection is established. You can perform some initialization actions in this event, such as verifying the identity of the connecting user or rejecting the user's connection. You can notice that the <code>Worker::setWebsocket</code> method in this event will store the request information of the connecting user to the Websocket Pool provided by Burner. This is a necessary action because Burner must use this request information to trigger the processing of CodeIgniter4.</p>
<p>Next, you can see the <code>on('message')</code> event, which will be triggered when the WebSocket receives a message. You can notice that the <code>Worker::websocketProcesser</code> method in this event will pass the received message to CodeIgniter4 for processing, and then process the request after CodeIgniter4 is completed. If you have some special business logic that needs to be processed before CodeIgniter4 processes the request, you only need to remember to call <code>Worker::websocketProcesser</code> to process your request after everything is done.</p>
<p>Finally, you can see the <code>on('close')</code> event, which will be triggered when the WebSocket connection is closed. You can notice that the <code>Worker::unsetWebsocket</code> method in this event will remove the request information of the connecting user from the Websocket Pool provided by Burner.</p>
<p>In addition, WebSocket can also handle normal HTTP requests through the <code>on('request')</code> event. You can use the WebSocket server as a normal HTTP server.</p>
<h2 id="push-message">Push Message</h2>
<h3 id="simple-implementation">Simple Implementation</h3>
<p>Burner provides the <code>Worker::push</code> method to push messages to WebSocket connections. No matter where you are, you can push messages to users through the following method:</p>
<pre><code class="language-php">use Monken\CIBurner\OpenSwoole\Worker;
Worker::push(
    data: 'hi! It\'s Burner Websocket!',
    fd: Worker::getFrame()-&gt;fd
);
</code></pre>
<p>We recommend that you use the <code>Worker::push</code> method in the CodeIgniter4 controller to push messages, just like this:</p>
<pre><code class="language-php">&lt;?php

namespace App\Controllers;

use Monken\CIBurner\OpenSwoole\Worker;

class BurnerWebsocket extends BaseController
{
    public function connect()
    {
        $frameData = Worker::getFrame();
        $nowUserFd = $frameData-&gt;fd;
        $data      = $frameData-&gt;data;

        Worker::push(
            data: printf('Hi! %s', $nowUserFd),
            fd: $nowUserFd
        );
    }
}
</code></pre>
<p>This Controller may be accessed through the following rote:</p>
<pre><code class="language-php">$routes-&gt;get('burner/websocket', 'BurnerWebsocket::connect');
</code></pre>
<p>After the user shakes hands with Burner via Websocket and <code>burner/websocket</code>, Burner then passes the connection to CodeIgniter4 so that you can work on it in CodeIgniter4. Here, you can use CodeIgniter4's features to your heart's content to work with your business logic.</p>
<h2 id="available-methods">Available Methods</h2>
<h3 id="worker::push">Worker::push</h3>
<p>Push messages to WebSocket connections.</p>
<h4 id="parameters">Parameters</h4>
<table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>data</td><td>string or binary</td><td>The message to push</td></tr>
<tr><td>fd</td><td>int</td><td>The fd of the connection to push</td></tr>
<tr><td>opcode</td><td>int</td><td>The type of data to pass. OpenSwoole's <code>WEBSOCKET_OPCODE_TEXT</code>, <code>WEBSOCKET_OPCODE_BINARY</code> or <code>WEBSOCKET_OPCODE_PING</code></td></tr>
</tbody></table>
<h4 id="example">Example</h4>
<pre><code class="language-php">use Monken\CIBurner\OpenSwoole\Worker;
use OpenSwoole\WebSocket\Server;

Worker::push(
    data: 'hi! It\'s Burner Websocket!',
    fd: Worker::getFrame()-&gt;fd,
    opcode: Server::WEBSOCKET_OPCODE_TEXT
);
</code></pre>
<h3 id="worker::pushall">Worker::pushAll</h3>
<p>Push messages to all WebSocket connections, or enumerate some connection fd to push messages.</p>
<h4 id="parameters">Parameters</h4>
<table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>data</td><td>string or callable</td><td>The message to push, or a callback function</td></tr>
<tr><td>fds</td><td>array</td><td>The fd of the connection to push, if not passed in, it will be all the current clients connected to the server</td></tr>
<tr><td>opcode</td><td>int</td><td>The type of data to pass. OpenSwoole's <code>WEBSOCKET_OPCODE_TEXT</code>, <code>WEBSOCKET_OPCODE_BINARY</code> or <code>WEBSOCKET_OPCODE_PING</code></td></tr>
</tbody></table>
<h4 id="push-with-string">Push with String</h4>
<p>Pushes the string to all connections.</p>
<pre><code class="language-php">use Monken\CIBurner\OpenSwoole\Worker;
use OpenSwoole\WebSocket\Server;

Worker::pushAll(
    data: 'hi! It\'s Burner Websocket!',
    fds: [1, 2, 3],
    opcode: Server::WEBSOCKET_OPCODE_TEXT
);
</code></pre>
<h4 id="push-with-callback">Push with Callback</h4>
<p>Push messages with Callback to include more processing logic.</p>
<pre><code class="language-php">use Monken\CIBurner\OpenSwoole\Worker;
use OpenSwoole\WebSocket\Server;

Worker::pushAll(
    data: static function (int $fd) {
        // $fd is the fd of the connection to push
        // You can do some special processing here, and then return the message to push
        return sprintf('hi! It\'s Burner Websocket! fd: %d', $fd);
    },
    fds: [1, 2, 3],
    opcode: Server::WEBSOCKET_OPCODE_TEXT
);
</code></pre>
<h4 id="push-with-callback-and-more-setting">Push with Callback and more setting</h4>
<p>You can also return an array to set the <code>opcode</code> of the message to push.</p>
<pre><code class="language-php">use Monken\CIBurner\OpenSwoole\Worker;
use OpenSwoole\WebSocket\Server;

Worker::pushAll(
    data: static function (int $fd) {
        // $fd is the fd of the connection to push
        // You can do some special processing here, and then return the message to push
        return [
            // The message to push
            'message' =&gt; sprintf('hi! It\'s Burner Websocket! fd: %d', $fd),
            // The type of data to pass
            'opcode' =&gt; Server::WEBSOCKET_OPCODE_TEXT 
        ];
    },
    fds: [1, 2, 3]
);
</code></pre>
<h3 id="worker::getframe">Worker::getFrame</h3>
<p>You can get the current WebSocket Frame at any where in your program.</p>
<h4 id="example">Example</h4>
<pre><code class="language-php">
use Monken\CIBurner\OpenSwoole\Worker;

$frame = Worker::getFrame();
</code></pre>
<p>The type of <code>$frame</code> is <code>OpenSwoole\WebSocket\Frame</code>, you can refer to the <a href="https://openswoole.com/docs/modules/swoole-websocket-frame">OpenSwoole documentation</a> to learn more.</p>
<h2 id="events">Events</h2>
<h3 id="burnerafterpushmessage">burnerAfterPushMessage</h3>
<p>When Burner pushes a message to a WebSocket connection, the <code>burnerAfterPushMessage</code> event will be triggered, and you can do some post-processing in this event.</p>
<p>You can register the <code>burnerAfterPushMessage</code> event as follows:</p>
<pre><code class="language-php">
Events::on('burnerAfterSendResponse',static function(\OpenSwoole\Http\Server $server, int $fd, bool $pushResult)
{
    // $server is the OpenSwoole Server instance
    // $fd is the fd of the current connection
    // $pushResult is the result of pushing the message
});

</code></pre>
<h3 id="burnerafterpushallmessage">burnerAfterPushAllMessage</h3>
<p>When Burner pushes a message to all WebSocket connections, the <code>burnerAfterPushAllMessage</code> event will be triggered, and you can do some post-processing in this event.</p>
<p>You can register the <code>burnerAfterPushAllMessage</code> event as follows:</p>
<pre><code class="language-php">
Events::on('burnerAfterPushAllMessage',static function(\OpenSwoole\Http\Server $server, array $fds)
{
    // $server is the OpenSwoole Server instance
    // $fds is the fd of the current connection array
});

</code></pre>

            </div>
            <div class='sidebar-right'>
                <div class='page-nav' id='page-nav'>
                    <p class='page-nav-header'>On this page</p>
                    <ul>
                        
                        <li class='page-nav-level-1'>
                            <a href='#openswoole-http'>OpenSwoole HTTP</a>
                        </li>
                        
                        <li class='page-nav-level-2'>
                            <a href='#events'>Events</a>
                        </li>
                        
                        <li class='page-nav-level-3'>
                            <a href='#burneraftersendresponse'>burnerAfterSendResponse</a>
                        </li>
                        
                        <li class='page-nav-level-1'>
                            <a href='#openswoole-websocket'>OpenSwoole Websocket</a>
                        </li>
                        
                        <li class='page-nav-level-2'>
                            <a href='#push-message'>Push Message</a>
                        </li>
                        
                        <li class='page-nav-level-3'>
                            <a href='#simple-implementation'>Simple Implementation</a>
                        </li>
                        
                        <li class='page-nav-level-2'>
                            <a href='#available-methods'>Available Methods</a>
                        </li>
                        
                        <li class='page-nav-level-3'>
                            <a href='#worker::push'>Worker::push</a>
                        </li>
                        
                        <li class='page-nav-level-4'>
                            <a href='#parameters'>Parameters</a>
                        </li>
                        
                        <li class='page-nav-level-4'>
                            <a href='#example'>Example</a>
                        </li>
                        
                        <li class='page-nav-level-3'>
                            <a href='#worker::pushall'>Worker::pushAll</a>
                        </li>
                        
                        <li class='page-nav-level-4'>
                            <a href='#parameters'>Parameters</a>
                        </li>
                        
                        <li class='page-nav-level-4'>
                            <a href='#push-with-string'>Push with String</a>
                        </li>
                        
                        <li class='page-nav-level-4'>
                            <a href='#push-with-callback'>Push with Callback</a>
                        </li>
                        
                        <li class='page-nav-level-4'>
                            <a href='#push-with-callback-and-more-setting'>Push with Callback and more setting</a>
                        </li>
                        
                        <li class='page-nav-level-3'>
                            <a href='#worker::getframe'>Worker::getFrame</a>
                        </li>
                        
                        <li class='page-nav-level-4'>
                            <a href='#example'>Example</a>
                        </li>
                        
                        <li class='page-nav-level-2'>
                            <a href='#events'>Events</a>
                        </li>
                        
                        <li class='page-nav-level-3'>
                            <a href='#burnerafterpushmessage'>burnerAfterPushMessage</a>
                        </li>
                        
                        <li class='page-nav-level-3'>
                            <a href='#burnerafterpushallmessage'>burnerAfterPushAllMessage</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
            <div class='wave-container'>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
                    <path fill-opacity="0.35"
                        d="M0,192L60,213.3C120,235,240,277,360,277.3C480,277,600,235,720,192C840,149,960,107,1080,122.7C1200,139,1320,213,1380,250.7L1440,288L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z">
                    </path>
                    <path fill-opacity="0.5"
                        d="M0,160L60,181.3C120,203,240,245,360,229.3C480,213,600,139,720,138.7C840,139,960,213,1080,229.3C1200,245,1320,203,1380,181.3L1440,160L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z">
                    </path>
                    <path fill-opacity="0.2"
                        d="M0,224L60,197.3C120,171,240,117,360,117.3C480,117,600,171,720,186.7C840,203,960,181,1080,186.7C1200,192,1320,224,1380,240L1440,256L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z">
                    </path>
                </svg>
                <p>Powered by <a href='https://cli.doctave.com' target='_blank'>Doctave</a></p>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="/en/assets/katex.js?v=1679822342"></script>
    <script type="text/javascript" src="/en/assets/mermaid.js?v=1679822342"></script>
    <script type="text/javascript" src="/en/assets/elasticlunr.js?v=1679822342"></script>
    <script type="text/javascript" src="/en/assets/prism.js?v=1679822342"></script>
    <script type="text/javascript" src="/en/assets/doctave-app.js?v=1679822342"></script>

    
</body>

</html>